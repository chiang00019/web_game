# 資料庫架構文件 (db.md)

本文檔詳細介紹了專案資料庫的結構、每個資料表的作用，以及在設計和實現過程中使用的關鍵 PostgreSQL 和 Supabase 技術。

## 核心技術與概念

在深入了解每個資料表之前，先介紹本架構中使用的幾個核心技術：

1.  **PostgreSQL `TRIGGER` (觸發器):**
    *   **用途:** 用於在特定事件（如 `INSERT`, `UPDATE`）發生時，自動執行一個函數。
    *   **應用:**
        *   `on_auth_user_created`: 當新使用者在 `auth.users` 表註冊時，自動將其資料複製到 `public.profiles` 表。
        *   `on_order_updated`: 當 `order` 表的某筆記錄被更新時，自動更新其 `updated_at` 時間戳。

2.  **PostgreSQL `FUNCTION` (函數):**
    *   **用途:** 封裝可重複使用的 SQL 邏輯。
    *   **應用:**
        *   `handle_new_user()`: 處理新使用者資料同步的邏輯。
        *   `handle_updated_at()`: 更新時間戳的邏輯。
        *   `is_admin()`: 一個輔助函數，用於在 RLS 策略中快速檢查當前使用者是否為管理員。

3.  **Supabase Row Level Security (RLS):**
    *   **用途:** 這是 Supabase 的核心安全機制。它允許我們為資料表的「每一行」定義精細的存取權限策略。沒有 RLS，任何擁有前端金鑰的人都能存取所有資料。
    *   **應用:** 為幾乎所有資料表都設定了 RLS 策略，確保：
        *   使用者只能讀取和修改自己的資料（例如個人檔案、訂單）。
        *   管理員 (`is_admin = true`) 擁有更高的權限，可以存取所有人的資料。
        *   某些公開資訊（如遊戲列表、橫幅）可以被任何人讀取。

4.  **`INDEX` (索引):**
    *   **用途:** 提升資料庫查詢效能。當資料表變得龐大時，對沒有索引的欄位進行查詢會非常緩慢。
    *   **應用:** 在經常被用於查詢條件 (`WHERE`) 或關聯 (`JOIN`) 的外鍵和欄位上都建立了索引，例如 `order.user_id`, `order.status` 等。

5.  **`FOREIGN KEY` (外鍵約束):**
    *   **用途:** 確保資料的引用完整性。例如，一筆訂單 (`order`) 的 `game_id` 必須對應到 `game` 表中一個實際存在的遊戲。
    *   **應用:** 在所有相關的資料表之間都建立了外鍵關聯。

---

## 資料表詳解

### `public.profiles`

*   **作用:** 儲存使用者的公開個人資料以及管理員狀態。
*   **說明:** 此表與 Supabase 的 `auth.users` 表透過 `user_id` (UUID) 進行一對一關聯。當新使用者註冊時，`handle_new_user` 觸發器會自動將其 `user_id` 和 `user_name` 複製到此表中。
*   **關鍵欄位:**
    *   `user_id`: 使用者的唯一標識，外鍵關聯到 `auth.users.id`。
    *   `is_admin`: 布林值，用於判斷使用者是否為管理員。這是 RLS 權限判斷的核心。

### `public.game`

*   **作用:** 儲存所有遊戲的基本資訊。
*   **RLS 策略:**
    *   任何人都可以讀取 (`SELECT`) 所有遊戲的資訊。
    *   只有管理員可以新增、修改或刪除 (`INSERT`, `UPDATE`, `DELETE`) 遊戲。

### `public.game_packages`

*   **作用:** 儲存每個遊戲可供購買的具體商品或儲值包。
*   **說明:** 一個遊戲 (`game`) 可以有多個儲值包 (`game_packages`)。
*   **RLS 策略:**
    *   任何人都可以讀取所有儲值包的資訊。
    *   只有管理員可以管理儲-值包。

### `public.order`

*   **作用:** 儲存所有的訂單記錄。
*   **說明:** 這是系統的核心資料表之一。`user_id` 被設定為 `NOT NULL`，確保每筆訂單都必須對應到一位已登入的使用者。
*   **關鍵欄位:**
    *   `status`: 使用 `order_status` ENUM 類型，確保訂單狀態的資料一致性。
    *   `created_at` / `updated_at`: 自動記錄訂單的建立與最後更新時間。
*   **RLS 策略:**
    *   使用者只能建立和查看自己的訂單。
    *   管理員可以存取所有使用者的訂單。

### `public.payment_method`

*   **作用:** 儲存所有支援的付款方式。
*   **RLS 策略:**
    *   公開可讀。
    *   僅限管理員管理。

### `public.banner`

*   **作用:** 儲存用於在網站首頁或其他地方顯示的橫幅廣告資訊。
*   **RLS 策略:**
    *   公開可讀。
    *   僅限管理員管理。

### `public.allow_payment_method`

*   **作用:** 一個多對多關聯表，用於定義「哪個遊戲」支援「哪些付款方式」。
*   **說明:** 透過此表，可以為不同的遊戲設定不同的可用付款選項。

### `public.use` & `public.add_value_process`

*   **作用:** 這兩個表共同定義了「哪個遊戲」需要執行「哪個儲值流程」。
*   **說明:** `add_value_process` 表中的 `script` 欄位目前為 `text`，用於記錄流程的描述或標識。實際的儲值邏輯應在應用程式的後端 (Serverless Functions) 中實現，而不是直接在資料庫中執行腳本，以獲得更好的可維護性和安全性。
