# 系統功能規格書 (System Functional Specification)

## 1. 專案概述

### 1.1. 背景與目標
本專案旨在開發一個輕量級的遊戲儲值網站。目標是提供一個直觀的介面，讓使用者可以輕鬆提交儲值訂單，同時也為管理員提供一個高效的後台系統，用以管理遊戲項目和處理訂單。本系統將透過簡化訂單流程與觸發自動化腳本，來提升整體營運效率。

### 1.2. 使用者故事 (User Stories)

- **作為一個遊戲玩家 (一般使用者):**
    - 我想要瀏覽一個清晰的遊戲列表，以便找到我需要儲值的遊戲。
    - 我想要在一個專屬頁面查看遊戲的詳細資訊，並填寫我的角色ID來下訂單。
    - 我想要在提交訂單後，能清楚地知道下一步該如何完成付款。

- **作為一個網站管理員:**
    - 我想要一個受密碼保護的後台，來管理網站的內容。
    - 我想要能夠輕鬆地新增、修改或下架商店中的遊戲。
    - 我想要查看所有使用者的訂單，並能快速篩選出那些等待我確認付款的訂單。
    - 我想要在確認收到使用者的款項後，只需點擊一個按鈕，就能將訂單標記為「已付款」，並自動觸發後續的儲值流程。

### 1.3. 技術規格
- **前端框架:** Next.js (React)
- **程式語言:** TypeScript
- **後端服務:** Supabase (包含 PostgreSQL 資料庫, Auth, Storage)
- **樣式方案:** Tailwind CSS
- **部署平台:** Vercel

---

## 2. 功能詳述

本章節將依據 `SRS.md` 中定義的需求，對每個功能模組的具體流程、操作和規則進行詳細說明。

### 2.1. 驗證模組 (Authentication)

#### 2.1.1. 使用者註冊
- **觸發條件:** 使用者在登入頁面點擊「註冊」選項。
- **流程:**
    1. 系統顯示註冊表單，欄位包含：使用者名稱、電子郵件、密碼、確認密碼。
    2. 使用者填寫完畢後點擊「註冊」。
    3. 前端進行基本驗證（如：欄位不得為空、密碼與確認密碼必須相符）。
    4. 驗證通過後，向後端 API (`/api/auth/signup`) 發送請求。
    5. 後端呼叫 Supabase Auth 進行註冊，並觸發 `on_auth_user_created` 函數，將新使用者資料同步至 `public.profiles` 表。
- **成功結果:** 使用者帳號建立成功，自動登入並導向商店主頁。
- **失敗/例外:**
    - 若電子郵件已被註冊，系統應提示「此電子郵件已被使用」。
    - 若輸入格式錯誤，應提示具體的錯誤訊息。

#### 2.1.2. 使用者登入
- **觸發條件:** 使用者在登入頁面填寫資料後點擊「登入」。
- **流程:**
    1. 系統顯示登入表單，欄位包含：電子郵件、密碼。
    2. 使用者填寫完畢後點擊「登入」。
    3. 向後端 API (`/api/auth/login`) 發送請求。
    4. 後端呼叫 Supabase Auth 驗證使用者憑證。
- **成功結果:** 使用者成功登入。若使用者為管理員 (`is_admin = true`)，導覽列會顯示「管理後台」連結；若為一般使用者，則導向商店主頁。
- **失敗/例外:**
    - 若帳號或密碼錯誤，系統應提示「電子郵件或密碼不正確」。

### 2.2. 商店模組 (Shop)

#### 2.2.1. 瀏覽遊戲列表
- **對應需求:** `REQ-FUN-001`
- **流程:**
    1. 使用者進入 `/shop` 頁面。
    2. 系統從 `public.game` 資料表讀取所有 `is_active = true` 的遊戲資料。
    3. 遊戲以卡片形式陳列，每張卡片顯示遊戲圖片、名稱和價格區間。

#### 2.2.2. 提交訂單
- **對應需求:** `REQ-FUN-002` to `REQ-FUN-008`
- **流程:**
    1. 使用者點擊某個遊戲卡片，進入 `/shop/[game_id]` 頁面。
    2. 系統檢查使用者登入狀態，若未登入，則顯示登入提示或彈出登入視窗。
    3. 登入後，頁面顯示該遊戲的詳細資訊以及訂單表單。
    4. 使用者在表單中填寫「遊戲角色ID」等必要資訊，並選擇一個儲值包。
    5. 使用者點擊「提交訂單」。
    6. 系統向後端 API (`/api/orders`) 發送 `POST` 請求，請求內容包含 `user_id`, `game_id`, `package_id`, `character_id` 等。
    7. API 驗證資料無誤後，在 `public.order` 資料表中插入一筆新紀錄，`status` 欄位預設為 `pending`。
    8. 前端收到成功回應後，顯示「訂單已成功提交！」訊息。

### 2.3. 管理後台模組 (Admin Panel)

#### 2.3.1. 權限控制
- **對應需求:** `REQ-NFN-001`
- **流程:**
    1. 所有 `/admin/**` 路徑的頁面和 `/api/admin/**` 的 API 路由，都必須經過權限中介軟體驗證。
    2. 中介軟體會檢查當前 session 的使用者 `user_id`，並在 `public.profiles` 表中查詢其 `is_admin` 欄位。
    3. 若 `is_admin` 不為 `true`，則拒絕存取，將使用者導向首頁或回傳 403 Forbidden 錯誤。

#### 2.3.2. 訂單管理
- **對應需求:** `REQ-FUN-011` to `REQ-FUN-014`
- **流程:**
    1. 管理員進入 `/admin/orders` 頁面。
    2. 系統預設顯示所有 `status = 'pending'` 的訂單，並提供篩選器可查看所有訂單或已完成訂單。
    3. 每筆訂單以表格形式呈現，包含訂單號、使用者名稱、遊戲、金額、角色ID、下單時間等資訊。
    4. 對於每筆 `pending` 的訂單，旁邊有一個「確認收款」按鈕。
    5. 管理員點擊「確認收款」按鈕。
    6. 系統向後端 API (`/api/orders/[order_id]`) 發送 `PUT` 請求，將 `status` 更新為 `paid`。
    7. **Hook 觸發:** 在 API 成功更新資料庫後，觸發對應的儲值腳本掛鉤，並傳入必要的訂單參數。
    8. 前端即時更新該筆訂單的顯示狀態。

#### 2.3.3. 遊戲管理
- **對應需求:** `REQ-FUN-015`, `REQ-FUN-016`
- **流程:**
    1. 管理員進入 `/admin/games` 頁面。
    2. 頁面顯示所有遊戲的列表，並提供「新增遊戲」按鈕。
    3. **新增:** 點擊「新增遊戲」，彈出表單，填寫遊戲名稱、描述、圖片URL等資訊後儲存。
    4. **編輯:** 點擊既有遊戲旁的「編輯」按鈕，在表單中修改資訊後儲存。
    5. **刪除/停用:** 點擊「刪除」或「停用」按鈕，將遊戲從商店頁面隱藏（建議使用軟刪除，如設定 `is_active = false`）。

---

## 3. API 規格

*(此處為簡化版，實際開發應更詳細)*

| 功能 | 路徑 | 方法 | 參數/Body | 回應 | 說明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 使用者註冊 | `/api/auth/signup` | `POST` | `{ email, password, username }` | `{ user, session }` | 建立新使用者 |
| 使用者登入 | `/api/auth/login` | `POST` | `{ email, password }` | `{ user, session }` | 驗證使用者並建立 session |
| 建立訂單 | `/api/orders` | `POST` | `{ game_id, package_id, character_id }` | `{ order_id, status }` | 登入使用者建立新訂單 |
| 更新訂單狀態 | `/api/orders/[id]` | `PUT` | `{ status: 'paid' }` | `{ success: true }` | (管理員) 更新訂單狀態 |
| 取得所有遊戲 | `/api/games` | `GET` | - | `[Game]` | 取得所有公開遊戲 |
| 新增遊戲 | `/api/games` | `POST` | `{ name, description, ... }` | `{ game_id }` | (管理員) 新增遊戲 |

---

## 4. 資料庫設計 (Schema)

*(此處為簡化版，詳細請參考 `db.md`)*

- **`profiles`**: `user_id (pk)`, `username`, `is_admin (boolean)`
- **`game`**: `id (pk)`, `name`, `description`, `image_url`, `is_active (boolean)`
- **`game_packages`**: `id (pk)`, `game_id (fk)`, `name`, `price`
- **`order`**: `id (pk)`, `user_id (fk)`, `package_id (fk)`, `character_id`, `status (enum: pending, paid)`, `created_at`

---

## 5. 開發時程 (Placeholder)

| 階段 | 主要任務 | 預計完成日期 |
| :--- | :--- | :--- |
| Phase 1 | 驗證系統與資料庫建置 | YYYY-MM-DD |
| Phase 2 | 商店與訂單提交功能 | YYYY-MM-DD |
| Phase 3 | 管理員後台 (遊戲與訂單管理) | YYYY-MM-DD |
| Phase 4 | 儲值 Hook 觸發與測試 | YYYY-MM-DD |
| Phase 5 | 整合測試與部署 | YYYY-MM-DD |
